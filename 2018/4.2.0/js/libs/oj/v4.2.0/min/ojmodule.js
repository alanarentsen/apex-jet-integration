/**
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
"use strict";
define(["ojs/ojcore","knockout","promise"],function(a,g){a.$v={};a.$v.Nd={viewPath:"text!views/",viewSuffix:".html",modelPath:"viewModels/",initializeMethod:"initialize",disposeMethod:"dispose",activatedHandler:"handleActivated",attachedHandler:"handleAttached",detachedHandler:"handleDetached",bindingsAppliedHandler:"handleBindingsApplied",deactivatedHandler:"handleDeactivated",transitionCompletedHandler:"handleTransitionCompleted"};o_("ModuleBinding.defaults",a.$v.Nd,a);a.$v.zEa="oj:blank";(function(){function c(b,
c,e,f,h,k,r){var l=c.canAnimate;if(null==l||l.call(c,b)){var m,u;if(l=c.prepareAnimation.call(c,b))m=l.newViewParent,u=l.oldViewParent;var n=m||e;u&&u!==e?d(f,u):n===e&&k(null);n!==e&&g.virtualElements.setDomNodeChildren(n,[]);h(n);var s=Array.prototype.slice.call(n.childNodes),w=!1,t=function(){if(!w&&(w=!0,e!==n)){p(e,s);var b=e.parentNode&&"OJ-MODULE"===e.parentNode.nodeName;a.Components&&!b&&(q(s,a.Components.$g),q(s,a.Components.nd))}},P=k.bind(null,u);b.newViewParent=m;b.oldViewParent=u;b.oldViewNodes=
f;b.removeOldView=P;b.insertNewView=t;var J=function(){P();t();r()};return c.animate.call(c,b).then(J,function(){J();a.D.error("ojModule animation promise was rejected")})}}function b(a,b,c){b=b||a;var d=[];c&&a===b&&(c.parentNode.removeChild(c),d.push(c));g.virtualElements.setDomNodeChildren(b,d)}function d(a,b){a.forEach(function(a){b.appendChild(a)})}function e(a,b){for(var c,d=0;d<a.length&&!(c=g.contextFor(a[d]));d++);return c&&c.$module&&c.$module==b}function f(a,b,c){var d={};c[0]&&(d.viewModel=
c[0]);c[1]&&(d.view=c[1]);b=new CustomEvent(b,{detail:d});a.dispatchEvent(b)}function h(a,b,c){if(a&&a[b]){var d={element:c[0],valueAccessor:c[1]};2<c.length&&(d.viewModel=c[2],3<c.length&&(d["boolean"===typeof c[3]?"fromCache":"cachedNodes"]=c[3]));return g.ignoreDependencies(a[b],a,[d])}}function k(b,c,d){if(null!=b&&(c=a.$v.Nd[c],null!=c&&b&&(c=b[c],"function"===typeof c))){var e=void 0;d&&(e={element:d[0],valueAccessor:d[1]},2<d.length&&(e["boolean"===typeof d[2]?"fromCache":"cachedNodes"]=d[2]));
return g.ignoreDependencies(c,b,[e])}}function l(a,b){if(a&&b){var c=a[b];"function"===typeof c&&g.ignoreDependencies(c,a)}}function m(a,b,c){var d=[];for(a=g.virtualElements.firstChild(a);null!=a&&a!=c;a=a.nextSibling)a!=b&&d.push(a);return d}function n(a,b){var c=[],d=g.virtualElements.firstChild(a);t(d,b,function(a){c.push(a)});return c}function t(a,b,c){for(;null!=a;){var d=g.virtualElements.nextSibling(a),e=a.nodeType;a===b||1!==e&&8!==e||c(a);a=d}}function s(a,b,c,d){var e=g.bindingProvider.instance,
f=e.preprocessNode;f&&(t(b,d,function(a){f.call(e,a)}),b=g.virtualElements.firstChild(a));t(b,d,function(a){g.applyBindings(c,a)})}function p(a,b){for(var c=b.length-1;0<=c;c--)g.virtualElements.prepend(a,b[c])}function q(a,b){if(b)for(var c=0;c<a.length;c++){var d=a[c];1===d.nodeType&&b(d)}}function r(a,b){if("string"===typeof a)a=g.utils.parseHtmlFragment(a);else if(window.DocumentFragment?a instanceof DocumentFragment:a&&11===a.nodeType)a=g.utils.arrayPushAll([],a.childNodes);else if(Array.isArray(a))a=
g.utils.arrayPushAll([],a);else throw b(),"The View ("+a+") has an unsupported type";return a}function u(b,c){b=b?b:require;return new Promise(function(d,e){b([c],function(a){d(a)},function(b){a.D.error("ojModule failed to load "+c);e(b)})})}function w(a){return a?new Promise(function(b){a.then(b,b)}):a}g.bindingHandlers.ojModule={init:function(v,t,y,z,A){function B(a){if(a!=E)throw la;}function G(a){T(a,"disposeMethod",[v,t])}function C(){J&&(J(),J=null)}var H,M,F={},D,E=-1,O,P,J,N,R,L=v.parentNode&&
"OJ-MODULE"===v.parentNode.nodeName,T=L?function(){}:k,V=L?function(){}:h,Y=L?l:function(){},ea=L?f:function(){};g.utils.domNodeDisposal.addDisposeCallback(v,function(){G(H);for(var a=Object.keys(F),b=0;b<a.length;b++)G(F[a[b]].dp);C()});var la=Error("Promise cancelled because ojModule is fetching new View and ViewModel"),Q=v;8===v.nodeType&&(Q=v.parentNode,g.virtualElements.setDomNodeChildren(v,[]),P=v.nextSibling);g.computed(function(){E++;J||(J=a.Context.getContext(Q).Dc().Xc({description:"ojModule binding on a node with the Id "+
v.id+"is loading the module. Binding evaluator: "+t.toString()}));var f=0===E,h=g.utils.unwrapObservable,k=h(t()),l,y,z,I,K,ia,aa,X,ja,fa,oa,Z,W,ha;"string"===typeof k?l=k:(l=h(k.name),y=h(k.viewName),z=h(k.params),I=h(k.viewModelFactory),K=h(k.createViewFunction),ia=h(k.cacheKey),aa=h(k.lifecycleListener),X=h(k.animation),Z=h(k.view),W=h(k.viewModel),ja=h(k.require),ha=h(k.cleanupMode));null==ja||ja instanceof Function||(oa=ja.viewPath,fa=ja.modelPath,ja=ja.instance);y=null==y?l:y;var ba=a.$v.zEa===
y,h=V(aa,"activated",[v,t]);ea(Q,"ojTransitionStart",[W]);var ka,da;if(ba)ka=Promise.resolve([]),da=Promise.resolve(null);else{var ma=null==ia?null:F[ia];null!=ma&&(delete F[ia],ka=Promise.resolve(ma.view),da=Promise.resolve(ma.dp))}null==ka&&null!=Z&&(ka=Promise.resolve(Z));if(null==da&&(null!=W?da=Promise.resolve(W):null!=I&&(da=g.ignoreDependencies(I.createViewModel,I,[z,t])),null==da&&null!=l&&(null==fa&&(fa=a.$v.Nd.modelPath),da=u(ja,fa+l)),null!=da&&(da=da.then(function(a,b){B(a);return b="function"===
typeof b?new b(z):T(b,"initializeMethod",[v,t])||b}.bind(null,E)),null==ka&&null!=K&&(ka=da.then(function(a,b){B(a);if(null==b)throw C(),"createViewFunction option cannot be used when the ViewModel is null";var c=b[K];if(null==c)throw C(),"function specified by the createViewFunction option was not found on the ViewModel";return c.call(b)}.bind(null,E)))),null==ka))if(null!=y)null==oa&&(oa=a.$v.Nd.viewPath),ka=u(ja,oa+y+a.$v.Nd.viewSuffix);else throw C(),Error("View name or view instance must be specified");
if(null==ka)throw C(),Error("ojModule is missing a View");var pa;null!=da&&(pa=da.then(function(a,b){B(a);return T(b,"activatedHandler",[v,t])}.bind(null,E)));Promise.all([ka,da,h,pa,M]).then(function(h,k){if(h==E){var l=k[0];if(null==l)throw C(),"The module's View was resolved to null";var u=r(l,C),y=k[1],B=!1,fa,oa=m(v,O,P),Z=n(v,O);null==D||N?L&&(fa=oa):(B=!0,fa=oa,O||(O=document.createElement("div"),O.className="oj-helper-module-cache",g.virtualElements.prepend(v,O)));var W=!1,l=function(c){if(!W){W=
!0;if(B)d(oa,O),b(v,c||v,O);else if(L&&"none"===R)for(c=0;c<fa.length;c++){var e=fa[c];e.parentNode.removeChild(e)}else Z.forEach(function(a){g.cleanNode(a)}),b(v,c||v,O);f||(V(aa,"detached",[v,t,H,fa]),T(H,"detachedHandler",[v,t,fa]),Y(H,"disconnected"),ea(Q,"ojViewDisconnected",[H,fa]),V(aa,"deactivated",[v,t,H]),T(H,"deactivatedHandler",[v,t]));B?(q(fa,a.Components?a.Components.Mq:null),F[D]={dp:H,view:fa}):L&&"none"===R||G(H);H=y;D=ia;N=ba;R=ha}},J=function(b){b=b||v;p(b,u);var c=null!=ma;c&&
q(u,a.Components?a.Components.ep:null);V(aa,"attached",[b,t,y,c]);T(y,"attachedHandler",[b,t,c]);Y(y,"connected");ea(Q,"ojViewConnected",[y]);var d=L&&e(u,y);c||d||(c=A.createChildContext(y,void 0,function(a){a.$module=y;a.$params=z}),L&&(c.$parent=void 0,c.$parents=void 0,c.$parentContext=void 0,c.$props=void 0,c.$slotNodeCounts=void 0,c.$unique=void 0,c.$uniqueId=void 0),s(b,u[0],c,O),V(aa,"bindingsApplied",[b,t,y]),T(y,"bindingsAppliedHandler",[b,t]))},I=function(){V(aa,"transitionCompleted",[v,
t,y]);T(y,"transitionCompletedHandler",[v,t]);Y(y,"transitionCompleted");ea(Q,"ojTransitionEnd",[y]);C()};if(null!=X){var K=c({node:L?v.parentNode:v,valueAccessor:L?null:t,isInitial:f,oldViewModel:H,newViewModel:y},X,v,oa,J,l,I);M=w(K)}else M=void 0;M||(l(null),J(null),I())}}.bind(null,E),function(b,c){c!==la&&null!=c&&(C(),a.D.error(c))}.bind(null,E))},null,{disposeWhenNodeIsRemoved:v});return{controlsDescendantBindings:!0}}};g.virtualElements.allowedBindings.ojModule=!0})()});